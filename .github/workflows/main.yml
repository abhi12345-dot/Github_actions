name: ORT scan express subproject

on:
  workflow_dispatch:

jobs:
  ort-analysis-and-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout express repo with full Git history
        run: |
          mkdir -p source_projects
          git clone https://github.com/tiny-express/tiny-express.git source_projects/tiny-express

      - name: Create ORT directories
        run: |
          mkdir -p ort-output ort-config
          sudo chmod -R 777 ort-output ort-config
          echo "[]" > ort-config/curations.yml

      - name: Write ORT config
        run: |
          cat <<EOF > ort-config/config.yml
          ort:
            analyzer:
              allowDynamicVersions: true
            scanner:
              ignorePatterns:
                - "**/node_modules/**"
          EOF

      - name: Debug directory structure
        run: |
          echo "Current directory structure:"
          ls -R
          echo "ORT config file contents:"
          cat ort-config/config.yml

      - name: Run ORT analyze
        run: |
          echo "Starting ORT analysis at $(date)"
          docker run --rm \
            -u root \
            -e ORT_CONFIG_DIR=/ort/config \
            -v "$(pwd)/source_projects/tiny-express:/project" \
            -v "$(pwd)/ort-output:/ort/output" \
            -v "$(pwd)/ort-config:/ort/config" \
            ghcr.io/oss-review-toolkit/ort:latest \
            analyze -i /project -o /ort/output
          echo "Finished ORT analysis at $(date)"

      - name: Clean node_modules
        run: |
          echo "Removing node_modules..."
          find source_projects/tiny-express -name node_modules -exec rm -rf {} + || true

      - name: Run ORT scan
        run: |
          echo "Starting ORT scan at $(date)"
          docker run --rm \
            -u root \
            -e ORT_CONFIG_DIR=/ort/config \
            -v "$(pwd)/source_projects/tiny-express:/project" \
            -v "$(pwd)/ort-output:/ort/output" \
            -v "$(pwd)/ort-config:/ort/config" \
            ghcr.io/oss-review-toolkit/ort:latest \
            scan -i /ort/output/analyzer-result.yml -o /ort/output
          echo "Finished ORT scan at $(date)"

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: ort-results
          path: ort-output/
