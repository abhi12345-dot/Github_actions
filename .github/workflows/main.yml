name: ORT Scan Tiny Express Project

on:
  workflow_dispatch:

jobs:
  ort-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up tiny-express project
        run: |
          mkdir -p tiny-express
          cd tiny-express
          
          cat <<EOF > package.json
          {
            "name": "tiny-express-mit",
            "version": "1.0.0",
            "license": "MIT",
            "dependencies": {
              "express": "4.18.2",
              "morgan": "1.10.0"
            }
          }
          EOF
          
          npm install --silent
          chmod -R 777 .

      - name: Set up ORT environment
        run: |
          mkdir -p ort-config ort-output
          chmod -R 777 ort-output
          
          cat <<EOF > ort-config/config.yml
          ort:
            analyzer:
              allowDynamicVersions: true
              temp_dir: /tmp/ort-stash
              enabled_package_managers: ["NPM"]
              skip_excluded: true
            scanner:
              ignorePatterns:
                - "**/node_modules/**"
          EOF
          echo "[]" > ort-config/curations.yml

      - name: Run ORT analyze
        run: |
          echo "Starting ORT analysis at $(date)"
          docker run --rm \
            -v ${{ github.workspace }}/tiny-express:/project \
            -v ${{ github.workspace }}/ort-output:/ort/output \
            -v ${{ github.workspace }}/ort-config:/ort/config \
            -e ORT_CONFIG_DIR=/ort/config \
            -e ORT_DATA_DIR=/tmp/ort-data \
            -w /project \
            -u $(id -u):$(id -g) \
            ghcr.io/oss-review-toolkit/ort:latest \
            analyze -i /project -o /ort/output \
            --package-curations-file /ort/config/curations.yml
          echo "Finished ORT analysis at $(date)"

      - name: Verify analysis completed
        run: |
          if [ ! -f ort-output/analyzer-result.yml ]; then
            echo "Analysis failed!"
            exit 1
          fi

      - name: Run ORT scan
        run: |
          echo "Starting ORT scan at $(date)"
          docker run --rm \
            -v ${{ github.workspace }}/ort-output:/ort/output \
            -v ${{ github.workspace }}/ort-config:/ort/config \
            ghcr.io/oss-review-toolkit/ort:latest \
            scan -i /ort/output/analyzer-result.yml -o /ort/output
          echo "Finished ORT scan at $(date)"

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: ort-tiny-express-results
          path: ort-output/
